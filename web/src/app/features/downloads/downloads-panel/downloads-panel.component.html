<section
  class="rounded-3xl border p-6"
  [class.border-slate-200]="!store.isDark()"
  [class.bg-white]="!store.isDark()"
  [class.shadow-sm]="!store.isDark()"
  [class.border-slate-700]="store.isDark()"
  [class.bg-slate-900]="store.isDark()"
>
  <div class="flex items-center justify-between gap-3">
    <h3
      class="text-lg font-bold"
      [class.text-slate-900]="!store.isDark()"
      [class.text-white]="store.isDark()"
    >
      Downloads
    </h3>

    <div class="flex items-center gap-2">
      <app-ui-action-button
        label="Refresh local files"
        [isDark]="store.isDark()"
        size="sm"
        (clicked)="store.refreshLocalDownloadedFiles()"
      />
      <app-ui-action-button
        label="Clear actions"
        [isDark]="store.isDark()"
        size="sm"
        [disabled]="store.downloadHistory().length === 0"
        (clicked)="store.clearDownloadHistory()"
      />
    </div>
  </div>

  <p
    class="mt-2 text-xs"
    [class.text-slate-500]="!store.isDark()"
    [class.text-slate-400]="store.isDark()"
  >
    Downloads: {{ store.localDownloadedFiles().length }} | Actions:
    {{ store.downloadHistory().length }}
  </p>

  @if (store.localDownloadedFiles().length > 0) {
    <div class="mt-5">
      <h4
        class="text-sm font-semibold"
        [class.text-slate-800]="!store.isDark()"
        [class.text-slate-100]="store.isDark()"
      >
        Downloads (archive files) ({{ store.localDownloadedFiles().length }})
      </h4>
      <div class="mt-2 grid gap-2">
        @for (file of store.localDownloadedFiles(); track file.fullPath) {
          <app-local-downloaded-file-card
            [file]="file"
            [isDark]="store.isDark()"
            (rescueRequested)="startRescueLiteFromLocal($event)"
            (rescueDryRunRequested)="startRescueLiteDryRunFromLocal($event)"
          />
        }
      </div>
    </div>
  } @else {
    <p
      class="mt-4 text-sm"
      [class.text-slate-500]="!store.isDark()"
      [class.text-slate-300]="store.isDark()"
    >
      No downloaded archive files found in ~/Downloads/LenovoMotoFirmwareDownloader.
    </p>
  }

  <h4
    class="mt-6 text-sm font-semibold"
    [class.text-slate-800]="!store.isDark()"
    [class.text-slate-100]="store.isDark()"
  >
    Actions ({{ store.downloadHistory().length }})
  </h4>

  <app-rescue-flash-console
    [isDark]="store.isDark()"
    [download]="store.firmwareDownload()"
    [statusText]="store.status()"
    (cancelRequested)="store.cancelDownloadById($event)"
  />

  @if (store.downloadHistory().length > 0) {
    <div class="mt-4 grid gap-3">
      @for (entry of store.downloadHistory(); track entry.downloadId) {
        <app-download-history-entry-card [entry]="entry" [isDark]="store.isDark()" />
      }
    </div>
  } @else {
    <p
      class="mt-4 text-sm"
      [class.text-slate-500]="!store.isDark()"
      [class.text-slate-300]="store.isDark()"
    >
      No actions yet.
    </p>
  }
</section>

<app-rescue-options-dialog
  [isOpen]="rescueDialogOpen"
  [isDark]="store.isDark()"
  [title]="rescueDialogTitle()"
  [description]="rescueDialogDescription()"
  [targetLabel]="rescueDialogTargetLabel()"
  [dryRun]="rescueDialogDryRun"
  [dataReset]="rescueDialogDataReset"
  [flashTransport]="rescueDialogFlashTransport"
  [qdlStorage]="rescueDialogQdlStorage"
  [qdlSerial]="rescueDialogQdlSerial"
  [qdloaderDriverInstallBusy]="installingWindowsQdloaderDriver"
  [qdloaderDriverInstalled]="windowsQdloaderDriverInstalled"
  [spdDriverInstallBusy]="installingWindowsSpdDriver"
  [spdDriverInstalled]="windowsSpdDriverInstalled"
  [mtkDriverInstallBusy]="installingWindowsMtkDriver"
  [mtkDriverInstalled]="windowsMtkDriverInstalled"
  [showWindowsDriverInstall]="store.appInfo()?.platform === 'win32'"
  (close)="closeRescueDialog()"
  (confirm)="confirmRescueDialog()"
  (installWindowsQdloaderDriver)="installWindowsQdloaderDriver()"
  (installWindowsSpdDriver)="installWindowsSpdDriver()"
  (installWindowsMtkDriver)="installWindowsMtkDriver()"
  (dataResetChange)="setRescueDialogDataReset($event)"
  (flashTransportChange)="setRescueDialogFlashTransport($event)"
  (qdlStorageChange)="setRescueDialogQdlStorage($event)"
  (qdlSerialChange)="setRescueDialogQdlSerial($event)"
/>

<app-rescue-dry-run-plan-dialog
  [isDark]="store.isDark()"
  [plan]="store.rescueDryRunPlanDialog()"
  (close)="closeDryRunPlanDialog()"
/>
