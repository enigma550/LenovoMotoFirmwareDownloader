@if (isOpen()) {
  <div
    class="fixed inset-0 z-50 flex items-center justify-center bg-black/60 p-4"
    (click)="onBackdropClick()"
  >
    <div
      class="w-full max-w-xl rounded-2xl border p-5 shadow-xl"
      [class.border-slate-200]="!isDark()"
      [class.bg-white]="!isDark()"
      [class.border-slate-700]="isDark()"
      [class.bg-slate-900]="isDark()"
      (click)="onDialogClick($event)"
    >
      <h4
        class="text-base font-bold"
        [class.text-slate-900]="!isDark()"
        [class.text-slate-100]="isDark()"
      >
        {{ title() }}
      </h4>

      <p class="mt-2 text-xs" [class.text-slate-600]="!isDark()" [class.text-slate-300]="isDark()">
        {{ description() }}
      </p>

      @if (targetLabel()) {
        <p
          class="mt-2 break-all text-xs"
          [class.text-slate-600]="!isDark()"
          [class.text-slate-300]="isDark()"
        >
          {{ targetLabel() }}
        </p>
      }

      <p class="mt-3 text-sm" [class.text-slate-700]="!isDark()" [class.text-slate-200]="isDark()">
        Flash transport
      </p>
      <p class="mt-1 text-xs" [class.text-slate-500]="!isDark()" [class.text-slate-400]="isDark()">
        Choose command backend for Rescue Lite execution.
      </p>

      <div class="mt-3 flex flex-wrap gap-2">
        <app-ui-action-button
          label="Fastboot"
          [isDark]="isDark()"
          [active]="flashTransport() === 'fastboot'"
          (clicked)="onSelectFlashTransport('fastboot')"
        />
        <app-ui-action-button
          label="QDL"
          [isDark]="isDark()"
          [active]="flashTransport() === 'qdl'"
          (clicked)="onSelectFlashTransport('qdl')"
        />
        <app-ui-action-button
          label="Unisoc PAC"
          [isDark]="isDark()"
          [active]="flashTransport() === 'unisoc'"
          (clicked)="onSelectFlashTransport('unisoc')"
        />
        <app-ui-action-button
          label="MediaTek"
          [isDark]="isDark()"
          [active]="flashTransport() === 'mediatek'"
          (clicked)="onSelectFlashTransport('mediatek')"
        />
      </div>

      <p class="mt-3 text-sm" [class.text-slate-700]="!isDark()" [class.text-slate-200]="isDark()">
        Data reset
      </p>
      <p class="mt-1 text-xs" [class.text-slate-500]="!isDark()" [class.text-slate-400]="isDark()">
        @if (dryRun()) {
          Choose whether wipe commands should be included in the dry-run command plan.
        } @else {
          Choose whether user data should be wiped during rescue.
        }
      </p>

      <div class="mt-3 flex flex-wrap gap-2">
        <app-ui-action-button
          label="Yes"
          [isDark]="isDark()"
          [active]="dataReset() === 'yes'"
          (clicked)="onSelectDataReset('yes')"
        />
        <app-ui-action-button
          label="No"
          [isDark]="isDark()"
          [active]="dataReset() === 'no'"
          (clicked)="onSelectDataReset('no')"
        />
      </div>

      @if (flashTransport() === 'qdl') {
        <div class="mt-4 space-y-3">
          @if (showWindowsDriverInstall()) {
            <app-rescue-driver-install-card
              [isDark]="isDark()"
              title="Qualcomm driver"
              description="Windows only: install QDLoader HS-USB 9008 driver before using QDL rescue."
              [buttonLabel]="
                qdloaderDriverInstallBusy()
                  ? 'Installing driver...'
                  : qdloaderDriverInstalled()
                    ? 'Driver already installed'
                    : 'Install QDLoader Driver'
              "
              [buttonDisabled]="qdloaderDriverInstallBusy() || qdloaderDriverInstalled()"
              [installed]="qdloaderDriverInstalled()"
              installedNote="QDLoader driver package detected as installed."
              (install)="onInstallWindowsQdloaderDriver()"
            />
          }

          <p class="text-sm" [class.text-slate-700]="!isDark()" [class.text-slate-200]="isDark()">
            QDL storage
          </p>

          <div class="flex flex-wrap gap-2">
            <app-ui-action-button
              label="Auto"
              [isDark]="isDark()"
              [active]="qdlStorage() === 'auto'"
              (clicked)="onSelectQdlStorage('auto')"
            />
            <app-ui-action-button
              label="eMMC"
              [isDark]="isDark()"
              [active]="qdlStorage() === 'emmc'"
              (clicked)="onSelectQdlStorage('emmc')"
            />
            <app-ui-action-button
              label="UFS"
              [isDark]="isDark()"
              [active]="qdlStorage() === 'ufs'"
              (clicked)="onSelectQdlStorage('ufs')"
            />
          </div>

          <label
            class="block text-xs"
            [class.text-slate-600]="!isDark()"
            [class.text-slate-300]="isDark()"
          >
            Board serial
          </label>
          <input
            class="w-full rounded-lg border px-3 py-2 text-sm"
            [class.border-slate-300]="!isDark()"
            [class.bg-white]="!isDark()"
            [class.text-slate-900]="!isDark()"
            [class.border-slate-600]="isDark()"
            [class.bg-slate-900]="isDark()"
            [class.text-slate-100]="isDark()"
            type="text"
            placeholder="Optional"
            [value]="qdlSerial()"
            (input)="onQdlSerialInput($event)"
          />
        </div>
      }

      @if (flashTransport() === 'unisoc' && showWindowsDriverInstall()) {
        <div class="mt-4 space-y-3">
          <app-rescue-driver-install-card
            [isDark]="isDark()"
            title="Unisoc driver"
            description="Windows only: install SPD USB driver before using Unisoc PAC rescue."
            [buttonLabel]="
              spdDriverInstallBusy()
                ? 'Installing driver...'
                : spdDriverInstalled()
                  ? 'Driver installed in this session'
                  : 'Install SPD Driver'
            "
            [buttonDisabled]="spdDriverInstallBusy() || spdDriverInstalled()"
            [installed]="spdDriverInstalled()"
            installedNote="SPD driver installed in this session."
            (install)="onInstallWindowsSpdDriver()"
          />
        </div>
      }

      @if (flashTransport() === 'mediatek' && showWindowsDriverInstall()) {
        <div class="mt-4 space-y-3">
          <app-rescue-driver-install-card
            [isDark]="isDark()"
            title="MediaTek driver"
            description="Windows only: install MediaTek USB driver before using MediaTek rescue."
            [buttonLabel]="
              mtkDriverInstallBusy()
                ? 'Installing driver...'
                : mtkDriverInstalled()
                  ? 'Driver installed in this session'
                  : 'Install MediaTek Driver'
            "
            [buttonDisabled]="mtkDriverInstallBusy() || mtkDriverInstalled()"
            [installed]="mtkDriverInstalled()"
            installedNote="MediaTek driver installed in this session."
            (install)="onInstallWindowsMtkDriver()"
          />
        </div>
      }

      <div class="mt-5 flex items-center justify-end gap-2">
        <app-rescue-dialog-button
          label="Cancel"
          [isDark]="isDark()"
          variant="secondary"
          (clicked)="onBackdropClick()"
        />
        <app-rescue-dialog-button label="Continue" variant="primary" (clicked)="onConfirm()" />
      </div>
    </div>
  </div>
}
